{% extends "base.html" %}

{% block title %}InfoFlow - Social Media Simulation{% endblock %}

{% block extra_head %}
<!-- Add Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
<style>
    .parameter-card {
        margin-bottom: 15px;
    }
    .chart-container {
        height: 400px;
        margin-bottom: 30px;
    }
    .accordion-button {
        padding: 0.75rem 1rem;
    }
    .form-label {
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }
    .form-text {
        font-size: 0.8rem;
    }
    .range-value {
        font-size: 0.8rem;
        text-align: center;
        width: 40px;
        display: inline-block;
    }
    .range-container {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .form-range {
        flex-grow: 1;
    }
    .parameter-section {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }
    .parameter-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
    }
    .parameter-section h6 {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #495057;
    }
    
    /* Network Visualization Styles */
    #network-container {
        height: 500px;
        margin-bottom: 30px;
        position: relative;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        overflow: hidden;
        background-color: #f8f9fa;
    }
    
    .network-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 100;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .node {
        stroke: #fff;
        stroke-width: 1.5px;
    }
    
    .link {
        stroke: #999;
        stroke-opacity: 0.6;
    }
    
    .node-tooltip {
        position: absolute;
        text-align: left;
        padding: 8px;
        font: 12px sans-serif;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border: 0px;
        border-radius: 4px;
        pointer-events: none;
        z-index: 10;
    }
    
    /* Content Flow Visualization Styles */
    .content-path {
        fill: none;
        stroke-linecap: round;
        pointer-events: none;
    }
    
    .content-true {
        stroke: rgba(40, 167, 69, 0.7);  /* Bootstrap success color */
        fill: rgba(40, 167, 69, 0.2);
    }
    
    .content-false {
        stroke: rgba(220, 53, 69, 0.7);  /* Bootstrap danger color */
        fill: rgba(220, 53, 69, 0.2);
    }
    
    .content-fuzzy {
        stroke: rgba(255, 193, 7, 0.7);  /* Bootstrap warning color */
        fill: rgba(255, 193, 7, 0.2);
    }
    
    .content-node {
        stroke-width: 1.5px;
    }
    
    /* Optional hover effect for paths */
    .content-path:hover {
        stroke-width: 3px;
        opacity: 0.9 !important;
    }
    
    /* Pulsing animation for timeline view */
    .content-pulse {
        animation: pulse 1.5s ease-out infinite;
    }
    
    @keyframes pulse {
        0% {
            r: 6;
            stroke-width: 1px;
            stroke-opacity: 0.8;
        }
        70% {
            r: 15;
            stroke-width: 2px;
            stroke-opacity: 0.4;
        }
        100% {
            r: 20;
            stroke-width: 0px;
            stroke-opacity: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>Simulation Parameters</h4>
            </div>
            <div class="card-body">
                <form id="simulation-form">
                    <!-- Basic Parameters -->
                    <div class="parameter-card">
                        <h5>Simulation Setup</h5>
                        
                        <div class="mb-3">
                            <label for="steps" class="form-label">Number of Steps</label>
                            <input type="number" class="form-control" id="steps" name="steps" value="20" min="1" max="200">
                            <div class="form-text">How long to run the simulation</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="networkType" class="form-label">Network Type</label>
                            <select class="form-select" id="networkType" name="networkType">
                                <option value="small_world">Small World</option>
                                <option value="scale_free">Scale Free</option>
                                <option value="random">Random</option>
                            </select>
                            <div class="form-text">Type of social network structure connecting users</div>
                        </div>
                    </div>
                    
                    <!-- Advanced Parameters Accordion -->
                    <div class="accordion mb-3" id="parametersAccordion">
                        <!-- Social Media User Parameters -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="citizenHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#citizenCollapse" aria-expanded="false" aria-controls="citizenCollapse">
                                    Social Media Users
                                </button>
                            </h2>
                            <div id="citizenCollapse" class="accordion-collapse collapse" aria-labelledby="citizenHeading" data-bs-parent="#parametersAccordion">
                                <div class="accordion-body">
                                    <div class="parameter-section">
                                        <h6>Population</h6>
                                        <div class="mb-3">
                                            <label for="numCitizens" class="form-label">Number of Social Media Users</label>
                                            <input type="number" class="form-control" id="numCitizens" name="numCitizens" value="50" min="10" max="500">
                                            <div class="form-text">Regular users who consume and share content on social media</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Truth Seeking Behavior</h6>
                                        <div class="mb-3">
                                            <label for="truthSeekingMean" class="form-label">Truth Seeking Mean (-5 to 5)</label>
                                            <div class="range-container">
                                                <span class="range-value">-5</span>
                                                <input type="range" class="form-range" min="-5" max="5" step="0.5" id="truthSeekingMean" name="truth_seeking_mean" value="0">
                                                <span class="range-value">+5</span>
                                                <span class="range-value" id="truthSeekingMeanValue">0</span>
                                            </div>
                                            <div class="form-text">Average tendency to seek truth (negative values avoid truth)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="truthSeekingStd" class="form-label">Truth Seeking Standard Deviation</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="5" step="0.1" id="truthSeekingStd" name="truth_seeking_std" value="2.5">
                                                <span class="range-value">5</span>
                                                <span class="range-value" id="truthSeekingStdValue">2.5</span>
                                            </div>
                                            <div class="form-text">Variation in truth seeking behavior</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Cognitive Characteristics</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Confirmation Bias Range (0-10)</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <span class="range-value">0</span>
                                                        <input type="range" class="form-range" min="0" max="10" step="0.5" id="confirmationBiasMin" name="confirmation_bias_min" value="3">
                                                        <span class="range-value" id="confirmationBiasMinValue">3</span>
                                                    </div>
                                                    <div class="form-text">Minimum</div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <input type="range" class="form-range" min="0" max="10" step="0.5" id="confirmationBiasMax" name="confirmation_bias_max" value="8">
                                                        <span class="range-value">10</span>
                                                        <span class="range-value" id="confirmationBiasMaxValue">8</span>
                                                    </div>
                                                    <div class="form-text">Maximum</div>
                                                </div>
                                            </div>
                                            <div class="form-text">Tendency to favor content that aligns with existing truth assessment</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Critical Thinking Range (0-10)</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <span class="range-value">0</span>
                                                        <input type="range" class="form-range" min="0" max="10" step="0.5" id="criticalThinkingMin" name="critical_thinking_min" value="3">
                                                        <span class="range-value" id="criticalThinkingMinValue">3</span>
                                                    </div>
                                                    <div class="form-text">Minimum</div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <input type="range" class="form-range" min="0" max="10" step="0.5" id="criticalThinkingMax" name="critical_thinking_max" value="8">
                                                        <span class="range-value">10</span>
                                                        <span class="range-value" id="criticalThinkingMaxValue">8</span>
                                                    </div>
                                                    <div class="form-text">Maximum</div>
                                                </div>
                                            </div>
                                            <div class="form-text">Ability to evaluate credibility of information sources</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Social Conformity Range (0-10)</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <span class="range-value">0</span>
                                                        <input type="range" class="form-range" min="0" max="10" step="0.5" id="socialConformityMin" name="social_conformity_min" value="3">
                                                        <span class="range-value" id="socialConformityMinValue">3</span>
                                                    </div>
                                                    <div class="form-text">Minimum</div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <input type="range" class="form-range" min="0" max="10" step="0.5" id="socialConformityMax" name="social_conformity_max" value="8">
                                                        <span class="range-value">10</span>
                                                        <span class="range-value" id="socialConformityMaxValue">8</span>
                                                    </div>
                                                    <div class="form-text">Maximum</div>
                                                </div>
                                            </div>
                                            <div class="form-text">Tendency to align with the truth assessments of connected agents</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Initial Trust Levels</h6>
                                        <div class="mb-3">
                                            <label for="initialTrustCorporate" class="form-label">Trust in Corporate Social Media Accounts</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="10" step="0.5" id="initialTrustCorporate" name="initial_trust_in_corporate" value="5">
                                                <span class="range-value">10</span>
                                                <span class="range-value" id="initialTrustCorporateValue">5</span>
                                            </div>
                                            <div class="form-text">Starting trust level in corporate accounts</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="initialTrustInfluencers" class="form-label">Trust in Social Media Influencers</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="10" step="0.5" id="initialTrustInfluencers" name="initial_trust_in_influencers" value="5">
                                                <span class="range-value">10</span>
                                                <span class="range-value" id="initialTrustInfluencersValue">5</span>
                                            </div>
                                            <div class="form-text">Starting trust level in influencer accounts</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="initialTrustGovernment" class="form-label">Trust in Government Social Media Accounts</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="10" step="0.5" id="initialTrustGovernment" name="initial_trust_in_government" value="5">
                                                <span class="range-value">10</span>
                                                <span class="range-value" id="initialTrustGovernmentValue">5</span>
                                            </div>
                                            <div class="form-text">Starting trust level in government accounts</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Corporate Social Media Parameters -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="corporateMediaHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#corporateMediaCollapse" aria-expanded="false" aria-controls="corporateMediaCollapse">
                                    Corporate Social Media Accounts
                                </button>
                            </h2>
                            <div id="corporateMediaCollapse" class="accordion-collapse collapse" aria-labelledby="corporateMediaHeading" data-bs-parent="#parametersAccordion">
                                <div class="accordion-body">
                                    <div class="parameter-section">
                                        <h6>Population</h6>
                                        <div class="mb-3">
                                            <label for="numCorporateMedia" class="form-label">Number of Corporate Social Media Accounts</label>
                                            <input type="number" class="form-control" id="numCorporateMedia" name="numCorporateMedia" value="3" min="0" max="10">
                                            <div class="form-text">Official accounts of established media organizations</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Political Bias</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Political Bias Range (-5 to +5)</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <span class="range-value">-5</span>
                                                        <input type="range" class="form-range" min="-5" max="5" step="0.5" id="corporateBiasMin" name="corporate_bias_min" value="-3">
                                                        <span class="range-value" id="corporateBiasMinValue">-3</span>
                                                    </div>
                                                    <div class="form-text">Minimum (Anti-Trump)</div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <input type="range" class="form-range" min="-5" max="5" step="0.5" id="corporateBiasMax" name="corporate_bias_max" value="3">
                                                        <span class="range-value">+5</span>
                                                        <span class="range-value" id="corporateBiasMaxValue">3</span>
                                                    </div>
                                                    <div class="form-text">Maximum (Pro-Trump)</div>
                                                </div>
                                            </div>
                                            <div class="form-text">Political leaning distribution (Anti-Trump to Pro-Trump)</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Content Generation</h6>
                                        <div class="mb-3">
                                            <label for="truthCommitmentCorporate" class="form-label">Truth Commitment</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="10" step="0.5" id="truthCommitmentCorporate" name="truth_commitment_corporate" value="6">
                                                <span class="range-value">10</span>
                                                <span class="range-value" id="truthCommitmentCorporateValue">6</span>
                                            </div>
                                            <div class="form-text">Fact-checking threshold (higher = more accurate content)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="corporatePublicationRate" class="form-label">Publication Rate</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="1" step="0.05" id="corporatePublicationRate" name="corporate_publication_rate" value="0.8">
                                                <span class="range-value">1</span>
                                                <span class="range-value" id="corporatePublicationRateValue">0.8</span>
                                            </div>
                                            <div class="form-text">Frequency of content creation (higher = more frequent)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="corporateInfluenceReach" class="form-label">Influence Reach</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="1" step="0.05" id="corporateInfluenceReach" name="corporate_influence_reach" value="0.7">
                                                <span class="range-value">1</span>
                                                <span class="range-value" id="corporateInfluenceReachValue">0.7</span>
                                            </div>
                                            <div class="form-text">Portion of citizens reached (higher = wider reach)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Social Media Influencer Parameters -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="influencerHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#influencerCollapse" aria-expanded="false" aria-controls="influencerCollapse">
                                    Social Media Influencers
                                </button>
                            </h2>
                            <div id="influencerCollapse" class="accordion-collapse collapse" aria-labelledby="influencerHeading" data-bs-parent="#parametersAccordion">
                                <div class="accordion-body">
                                    <div class="parameter-section">
                                        <h6>Population</h6>
                                        <div class="mb-3">
                                            <label for="numInfluencers" class="form-label">Number of Social Media Influencers</label>
                                            <input type="number" class="form-control" id="numInfluencers" name="numInfluencers" value="5" min="0" max="20">
                                            <div class="form-text">Individuals with significant following and influence</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Political Bias</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Political Bias Range (-5 to +5)</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <span class="range-value">-5</span>
                                                        <input type="range" class="form-range" min="-5" max="5" step="0.5" id="influencerBiasMin" name="influencer_bias_min" value="-4">
                                                        <span class="range-value" id="influencerBiasMinValue">-4</span>
                                                    </div>
                                                    <div class="form-text">Minimum (Anti-Trump)</div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="range-container">
                                                        <input type="range" class="form-range" min="-5" max="5" step="0.5" id="influencerBiasMax" name="influencer_bias_max" value="4">
                                                        <span class="range-value">+5</span>
                                                        <span class="range-value" id="influencerBiasMaxValue">4</span>
                                                    </div>
                                                    <div class="form-text">Maximum (Pro-Trump)</div>
                                                </div>
                                            </div>
                                            <div class="form-text">Political leaning distribution (Anti-Trump to Pro-Trump)</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Content Generation</h6>
                                        <div class="mb-3">
                                            <label for="truthCommitmentInfluencer" class="form-label">Truth Commitment</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="10" step="0.5" id="truthCommitmentInfluencer" name="truth_commitment_influencer" value="4">
                                                <span class="range-value">10</span>
                                                <span class="range-value" id="truthCommitmentInfluencerValue">4</span>
                                            </div>
                                            <div class="form-text">Fact-checking threshold (higher = more accurate content)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="influencerPublicationRate" class="form-label">Publication Rate</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="1" step="0.05" id="influencerPublicationRate" name="influencer_publication_rate" value="0.9">
                                                <span class="range-value">1</span>
                                                <span class="range-value" id="influencerPublicationRateValue">0.9</span>
                                            </div>
                                            <div class="form-text">Frequency of content creation (higher = more frequent)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="influencerInfluenceReach" class="form-label">Influence Reach</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="1" step="0.05" id="influencerInfluenceReach" name="influencer_influence_reach" value="0.5">
                                                <span class="range-value">1</span>
                                                <span class="range-value" id="influencerInfluenceReachValue">0.5</span>
                                            </div>
                                            <div class="form-text">Portion of citizens reached (higher = wider reach)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Government Social Media Parameters -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="governmentHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#governmentCollapse" aria-expanded="false" aria-controls="governmentCollapse">
                                    Government Social Media Accounts
                                </button>
                            </h2>
                            <div id="governmentCollapse" class="accordion-collapse collapse" aria-labelledby="governmentHeading" data-bs-parent="#parametersAccordion">
                                <div class="accordion-body">
                                    <div class="parameter-section">
                                        <h6>Population</h6>
                                        <div class="mb-3">
                                            <label for="numGovernment" class="form-label">Number of Government Social Media Accounts</label>
                                            <input type="number" class="form-control" id="numGovernment" name="numGovernment" value="1" min="0" max="5">
                                            <div class="form-text">Official government accounts and information channels</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Political Bias</h6>
                                        <div class="mb-3">
                                            <label for="governmentBias" class="form-label">Political Bias (-5 to +5)</label>
                                            <div class="range-container">
                                                <span class="range-value">-5</span>
                                                <input type="range" class="form-range" min="-5" max="5" step="0.5" id="governmentBias" name="government_bias" value="1">
                                                <span class="range-value">+5</span>
                                                <span class="range-value" id="governmentBiasValue">1</span>
                                            </div>
                                            <div class="form-text">Political leaning (Anti-Trump to Pro-Trump)</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Content Generation</h6>
                                        <div class="mb-3">
                                            <label for="truthCommitmentGovernment" class="form-label">Truth Commitment</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="10" step="0.5" id="truthCommitmentGovernment" name="truth_commitment_government" value="5">
                                                <span class="range-value">10</span>
                                                <span class="range-value" id="truthCommitmentGovernmentValue">5</span>
                                            </div>
                                            <div class="form-text">Fact-checking threshold (higher = more accurate content)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="governmentPublicationRate" class="form-label">Publication Rate</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="1" step="0.05" id="governmentPublicationRate" name="government_publication_rate" value="0.7">
                                                <span class="range-value">1</span>
                                                <span class="range-value" id="governmentPublicationRateValue">0.7</span>
                                            </div>
                                            <div class="form-text">Frequency of content creation (higher = more frequent)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="governmentInfluenceReach" class="form-label">Influence Reach</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="1" step="0.05" id="governmentInfluenceReach" name="government_influence_reach" value="0.6">
                                                <span class="range-value">1</span>
                                                <span class="range-value" id="governmentInfluenceReachValue">0.6</span>
                                            </div>
                                            <div class="form-text">Portion of citizens reached (higher = wider reach)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Network Parameters -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="networkHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#networkCollapse" aria-expanded="false" aria-controls="networkCollapse">
                                    Network Parameters
                                </button>
                            </h2>
                            <div id="networkCollapse" class="accordion-collapse collapse" aria-labelledby="networkHeading" data-bs-parent="#parametersAccordion">
                                <div class="accordion-body">
                                    <div class="alert alert-info small">
                                        Network parameters apply based on the selected network type.
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Small World Network</h6>
                                        <div class="mb-3">
                                            <label for="smallWorldK" class="form-label">Neighbors (k)</label>
                                            <input type="number" class="form-control" id="smallWorldK" name="small_world_k" value="4" min="2" max="10">
                                            <div class="form-text">Number of nearest neighbors to connect</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="smallWorldP" class="form-label">Rewiring Probability</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="1" step="0.05" id="smallWorldP" name="small_world_p" value="0.1">
                                                <span class="range-value">1</span>
                                                <span class="range-value" id="smallWorldPValue">0.1</span>
                                            </div>
                                            <div class="form-text">Probability of rewiring each edge</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Scale Free Network</h6>
                                        <div class="mb-3">
                                            <label for="scaleFreeM" class="form-label">Edges per Node (m)</label>
                                            <input type="number" class="form-control" id="scaleFreeM" name="scale_free_m" value="3" min="1" max="10">
                                            <div class="form-text">Number of edges to add per new node</div>
                                        </div>
                                    </div>
                                    
                                    <div class="parameter-section">
                                        <h6>Random Network</h6>
                                        <div class="mb-3">
                                            <label for="randomP" class="form-label">Connection Probability</label>
                                            <div class="range-container">
                                                <span class="range-value">0</span>
                                                <input type="range" class="form-range" min="0" max="1" step="0.05" id="randomP" name="random_p" value="0.1">
                                                <span class="range-value">1</span>
                                                <span class="range-value" id="randomPValue">0.1</span>
                                            </div>
                                            <div class="form-text">Probability of creating an edge between nodes</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">Run Simulation</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>Results</h4>
            </div>
            <div class="card-body" id="results-container">
                <div id="loading" class="d-none text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Running simulation...</p>
                </div>
                
                <div id="results" class="d-none">
                    <div class="d-flex justify-content-end mb-3">
                        <div class="btn-group">
                            <button id="exportJsonBtn" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-file-earmark-code"></i> Export JSON
                            </button>
                            <button id="exportHtmlBtn" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-file-earmark-text"></i> Export Interactive HTML
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>Truth Assessment</h5>
                            <button class="btn btn-sm btn-outline-secondary export-chart-btn" data-chart="truthAssessmentChart">
                                <i class="bi bi-download"></i> Export Image
                            </button>
                        </div>
                        <canvas id="truthAssessmentChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>Trust Levels</h5>
                            <button class="btn btn-sm btn-outline-secondary export-chart-btn" data-chart="trustLevelsChart">
                                <i class="bi bi-download"></i> Export Image
                            </button>
                        </div>
                        <canvas id="trustLevelsChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>Trust Changes</h5>
                            <button class="btn btn-sm btn-outline-secondary export-chart-btn" data-chart="trustChangesChart">
                                <i class="bi bi-download"></i> Export Image
                            </button>
                        </div>
                        <canvas id="trustChangesChart"></canvas>
                    </div>
                    
                    <!-- Network Visualization -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Network Visualization</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" id="exportNetworkBtn">
                                    <i class="bi bi-download"></i> Export SVG
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="toggleNetworkViz">Show/Hide</button>
                            </div>
                        </div>
                        <div class="card-body" id="networkVizContainer">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="nodeColorSelect" class="form-label">Color Nodes By</label>
                                    <select class="form-select" id="nodeColorSelect">
                                        <option value="truth_assessment">Truth Assessment</option>
                                        <option value="trust_corporate">Trust in Corporate Media</option>
                                        <option value="trust_influencers">Trust in Influencers</option>
                                        <option value="trust_government">Trust in Government</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="layoutSelect" class="form-label">Layout Type</label>
                                    <select class="form-select" id="layoutSelect">
                                        <option value="force">Force-Directed</option>
                                        <option value="circular">Circular</option>
                                        <option value="grid">Grid</option>
                                        <option value="radial">Radial Tree</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="simulationControls" class="form-label">Visualization Controls</label>
                                    <div class="btn-group w-100" id="simulationControls">
                                        <button class="btn btn-sm btn-outline-secondary" id="resetZoom">Reset</button>
                                        <button class="btn btn-sm btn-outline-secondary" id="pauseSimulation">Pause</button>
                                        <button class="btn btn-sm btn-outline-secondary" id="refreshNetwork">Refresh</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="network-container">
                                <!-- D3.js network visualization will be rendered here -->
                                <div class="network-controls">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="showLabels" checked>
                                        <label class="form-check-label" for="showLabels">
                                            Show Labels
                                        </label>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <label class="form-label mb-1">Content Visualization</label>
                                        <select class="form-select form-select-sm mb-2" id="contentTypeSelect">
                                            <option value="">No Visualization</option>
                                            <option value="true">True Content (Accurate)</option>
                                            <option value="false">False Content (Inaccurate)</option>
                                            <option value="fuzzy">Fuzzy Content (Mixed)</option>
                                            <option value="all">All Content Types</option>
                                        </select>
                                        
                                        <div id="contentSelectionContainer" style="display: none;">
                                            <label class="form-label my-1 small">Select Specific Content Piece</label>
                                            <select class="form-select form-select-sm mb-2" id="specificContentSelect">
                                                <option value="">All Content</option>
                                            </select>
                                            <div class="small text-muted fst-italic mb-2">
                                                Content pieces are sorted by how far they spread through the network
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small>Visualization Mode</small>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-sm btn-outline-secondary active" id="showOverview">Overview</button>
                                                <button class="btn btn-sm btn-outline-secondary" id="showTimeline">Hop-by-Hop</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="timelineControls" class="mt-2" style="display: none;">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-secondary me-2" id="timeStep">Hop 0</span>
                                            <input type="range" class="form-range" id="timeSlider" min="0" max="0" value="0">
                                        </div>
                                        <div class="small text-muted fst-italic">
                                            Each hop represents one node in the content's spread path, not simulation time steps
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="alert alert-info small">
                                        <ul class="mb-0">
                                            <li><strong>Zoom:</strong> Use mouse wheel to zoom in/out</li>
                                            <li><strong>Pan:</strong> Click and drag to move around</li>
                                            <li><strong>Node Info:</strong> Hover over nodes for details</li>
                                            <li><strong>Interact:</strong> Click on a node to select that user</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Individual Agent Tracking -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Individual Social Media User Tracking</h5>
                            <button class="btn btn-sm btn-outline-primary" id="toggleAgentTracking">Show/Hide</button>
                        </div>
                        <div class="card-body" id="agentTrackingContainer" style="display:none;">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="agentSelect" class="form-label">Select User</label>
                                    <select class="form-select" id="agentSelect">
                                        <option value="">None Selected</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="agentMetricSelect" class="form-label">Metric to Display</label>
                                    <select class="form-select" id="agentMetricSelect">
                                        <option value="truth_assessment">Truth Assessment</option>
                                        <option value="trust_corporate">Trust in Corporate Accounts</option>
                                        <option value="trust_influencers">Trust in Influencers</option>
                                        <option value="trust_government">Trust in Government Accounts</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <canvas id="agentChart"></canvas>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">User Properties</div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <tbody>
                                                    <tr><th>ID</th><td id="agentId">-</td></tr>
                                                    <tr><th>Truth Assessment</th><td id="agentTruthAssessment">-</td></tr>
                                                    <tr><th>Confirmation Bias</th><td id="agentConfirmationBias">-</td></tr>
                                                    <tr><th>Critical Thinking</th><td id="agentCriticalThinking">-</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">Trust Levels</div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <tbody>
                                                    <tr><th>Corporate Media</th><td id="agentTrustCorporate">-</td></tr>
                                                    <tr><th>Influencers</th><td id="agentTrustInfluencers">-</td></tr>
                                                    <tr><th>Government</th><td id="agentTrustGovernment">-</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="initial-message">
                    <p class="text-center text-muted py-5">
                        Set your parameters and run the simulation to see results.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Chart objects
    let truthAssessmentChart;
    let trustLevelsChart;
    let trustChangesChart;
    let agentChart;
    
    // Network visualization objects
    let networkSimulation;
    let networkSvg;
    let networkZoom;
    let networkData;
    let networkNodes;
    let networkLinks;
    
    // Content flow visualization
    let contentFlowData;
    let contentFlowAnimation;
    let isContentFlowPlaying = false;
    let currentContentType = null; // 'true', 'false', or 'fuzzy'
    
    // Individual agent tracking
    let currentAgentData = null;
    let selectedAgentId = null;
    
    // Update range value displays
    function updateRangeValue(inputId) {
        const input = document.getElementById(inputId);
        const valueDisplay = document.getElementById(inputId + 'Value');
        if (input && valueDisplay) {
            valueDisplay.textContent = input.value;
            
            // Add event listener if not already added
            if (!input.hasListener) {
                input.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                });
                input.hasListener = true;
            }
        }
    }
    
    // Initialize all range displays
    // Content flow visualization focused on tracing individual content items
    function initializeContentFlowControls() {
        // Set up content type select
        document.getElementById('contentTypeSelect').addEventListener('change', function() {
            const contentType = this.value;
            currentContentType = contentType;
            
            // Clear existing visualization
            clearContentFlowVisualization();
            
            // Hide content selection and timeline controls if no type selected
            if (!contentType) {
                document.getElementById('contentSelectionContainer').style.display = 'none';
                document.getElementById('timelineControls').style.display = 'none';
                return;
            }
            
            // Filter content based on selected type
            const filteredContent = filterContentByType(contentType);
            
            // Populate specific content dropdown if we have content
            if (filteredContent.length > 0) {
                populateContentSelector(filteredContent);
                document.getElementById('contentSelectionContainer').style.display = 'block';
            } else {
                document.getElementById('contentSelectionContainer').style.display = 'none';
            }
            
            // Default to overview mode
            document.getElementById('showOverview').classList.add('active');
            document.getElementById('showTimeline').classList.remove('active');
            document.getElementById('timelineControls').style.display = 'none';
            
            // Show overview of all content matching the type
            showContentOverview(filteredContent);
        });
        
        // Set up specific content select
        document.getElementById('specificContentSelect').addEventListener('change', function() {
            const contentId = this.value;
            
            // If showing all content or none selected, show overview
            if (!contentId) {
                const filteredContent = filterContentByType(currentContentType);
                showContentOverview(filteredContent);
                
                // Hide timeline controls
                document.getElementById('timelineControls').style.display = 'none';
                return;
            }
            
            // If in timeline mode, show timeline, otherwise show single content path
            if (document.getElementById('showTimeline').classList.contains('active')) {
                showContentTimeline(contentId);
            } else {
                // Just show the single content path
                const content = window.contentFlowData.find(c => c.content_id === contentId);
                showContentOverview([content]);
            }
        });
        
        // Set up overview/timeline mode buttons
        document.getElementById('showOverview').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('showTimeline').classList.remove('active');
            document.getElementById('timelineControls').style.display = 'none';
            
            // Show appropriate content based on selections
            const contentId = document.getElementById('specificContentSelect').value;
            if (contentId) {
                // Show single content path
                const content = window.contentFlowData.find(c => c.content_id === contentId);
                showContentOverview([content]);
            } else {
                // Show all content of selected type
                const filteredContent = filterContentByType(currentContentType);
                showContentOverview(filteredContent);
            }
        });
        
        document.getElementById('showTimeline').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('showOverview').classList.remove('active');
            
            // Timeline only works for specific content
            const contentId = document.getElementById('specificContentSelect').value;
            if (contentId) {
                showContentTimeline(contentId);
            } else {
                // If no specific content selected, ask user to select one
                alert('Please select a specific content item to view its timeline');
                this.classList.remove('active');
                document.getElementById('showOverview').classList.add('active');
            }
        });
        
        // Set up timeline slider
        document.getElementById('timeSlider').addEventListener('input', function() {
            const step = parseInt(this.value);
            document.getElementById('timeStep').textContent = `Hop ${step}`;
            
            // Update visualization for this step
            const contentId = document.getElementById('specificContentSelect').value;
            if (contentId) {
                updateTimelineStep(contentId, step);
            }
        });
    }
    
    // Filter content based on selected type
    function filterContentByType(contentType) {
        if (!window.contentFlowData || !contentType) return [];
        
        let filteredContent = [];
        switch(contentType) {
            case 'true':
                filteredContent = window.contentFlowData.filter(c => c.accuracy >= 0.7);
                break;
            case 'false':
                filteredContent = window.contentFlowData.filter(c => c.accuracy <= 0.3);
                break;
            case 'fuzzy':
                filteredContent = window.contentFlowData.filter(c => c.accuracy > 0.3 && c.accuracy < 0.7);
                break;
            default:
                return [];
        }
        
        // Only include content that actually spread (has a path)
        return filteredContent.filter(c => c.spread_path && c.spread_path.length >= 2);
    }
    
    // Populate the content selector dropdown
    function populateContentSelector(contentItems) {
        const select = document.getElementById('specificContentSelect');
        
        // Clear existing options except the default
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // Sort content by path length (most spread first) and creation time
        const sortedContent = [...contentItems].sort((a, b) => {
            const aLength = a.spread_path ? a.spread_path.length : 0;
            const bLength = b.spread_path ? b.spread_path.length : 0;
            
            // First sort by path length (descending)
            if (bLength !== aLength) {
                return bLength - aLength;
            }
            
            // Then by creation time (ascending)
            return (a.created_step || 0) - (b.created_step || 0);
        });
        
        // Add content items as options
        sortedContent.forEach((content, index) => {
            const pathLength = content.spread_path ? content.spread_path.length : 0;
            if (pathLength < 2) return; // Skip content that didn't spread
            
            const option = document.createElement('option');
            option.value = content.content_id;
            option.textContent = `Content ${index + 1} (Spread to ${pathLength} nodes)`;
            select.appendChild(option);
        });
        
        // Select first option
        if (select.options.length > 1) {
            select.selectedIndex = 1;
            
            // Trigger change event to show first content
            const event = new Event('change');
            select.dispatchEvent(event);
        }
    }
    
    // Function to visualize content flow based on selected type
    function visualizeContentFlow(contentType) {
        if (!contentType || contentType === '') {
            clearContentFlowVisualization();
            document.getElementById('contentSelectionContainer').style.display = 'none';
            return;
        }
        
        // Store current content type
        window.currentContentType = contentType;
        
        // Filter content based on selected type
        let filteredContent = [];
        if (contentType === 'all') {
            filteredContent = window.contentFlowData || [];
        } else {
            filteredContent = filterContentByType(contentType);
        }
        
        // Populate specific content dropdown if we have content
        if (filteredContent.length > 0) {
            populateContentSelector(filteredContent);
            document.getElementById('contentSelectionContainer').style.display = 'block';
        } else {
            document.getElementById('contentSelectionContainer').style.display = 'none';
        }
        
        // Show overview of all content matching the type
        showContentOverview(filteredContent);
    }
    
    // Show overview of content paths
    function showContentOverview(contentItems) {
        if (!networkData || !networkData.nodes || !contentItems || contentItems.length === 0) return;
        
        // Clear existing visualization
        clearContentFlowVisualization();
        
        // Get node position mapping
        const nodePositions = {};
        networkData.nodes.forEach(node => {
            nodePositions[node.id] = { 
                x: node.x, 
                y: node.y,
                agent_id: node.agent_id 
            };
        });
        
        // Create SVG group for content visualization
        const contentGroup = d3.select(".network-group")
            .selectAll(".content-paths-group")
            .data([1])
            .join("g")
            .attr("class", "content-paths-group");
        
        // Process each content item
        contentItems.forEach((content, contentIndex) => {
            if (!content.spread_path || content.spread_path.length < 2) return;
            
            // Determine color class based on content accuracy
            let colorClass;
            if (content.accuracy >= 0.7) {
                colorClass = 'content-true';
            } else if (content.accuracy <= 0.3) {
                colorClass = 'content-false';
            } else {
                colorClass = 'content-fuzzy';
            }
            
            // Create path points
            const pathPoints = [];
            const nodeIds = new Set(); // Track which nodes are in this path
            
            for (let i = 0; i < content.spread_path.length; i++) {
                const nodeId = content.spread_path[i];
                if (nodePositions[nodeId]) {
                    pathPoints.push({
                        ...nodePositions[nodeId],
                        nodeId: nodeId,
                        isOrigin: i === 0
                    });
                    nodeIds.add(nodeId);
                }
            }
            
            if (pathPoints.length < 2) return;
            
            // Create a smooth line generator
            const lineGenerator = d3.line()
                .x(d => d.x)
                .y(d => d.y)
                .curve(d3.curveCatmullRom.alpha(0.5));
            
            // Add path with opacity based on number of items (more items = more transparent)
            contentGroup.append("path")
                .attr("d", lineGenerator(pathPoints))
                .attr("class", `content-path ${colorClass}`)
                .attr("data-content-id", content.content_id)
                .style("stroke-width", contentItems.length === 1 ? 2.5 : 1.5)
                .style("opacity", contentItems.length === 1 ? 0.8 : Math.max(0.1, 0.7 - (contentIndex * 0.05)));
            
            // If only showing one item, add visual indicators for each node in path
            if (contentItems.length === 1) {
                // Highlight each node in the path
                pathPoints.forEach((point, i) => {
                    // Different styling for origin vs relay points
                    const isOrigin = i === 0;
                    const radius = isOrigin ? 8 : 5;
                    const opacity = isOrigin ? 0.6 : 0.4;
                    
                    contentGroup.append("circle")
                        .attr("cx", point.x)
                        .attr("cy", point.y)
                        .attr("r", radius)
                        .attr("class", `content-node ${colorClass}`)
                        .style("fill-opacity", opacity)
                        .style("stroke-width", isOrigin ? 2 : 1);
                    
                    // Add step number for clarity
                    contentGroup.append("text")
                        .attr("x", point.x)
                        .attr("y", point.y - radius - 2)
                        .attr("text-anchor", "middle")
                        .attr("font-size", "9px")
                        .text(i + 1);
                });
            }
        });
    }
    
    // Show timeline visualization for a specific content
    function showContentTimeline(contentId) {
        if (!contentId || !networkData) return;
        
        // Find the selected content
        const content = window.contentFlowData.find(c => c.content_id === contentId);
        if (!content || !content.spread_path || content.spread_path.length < 2) return;
        
        // Create time steps based on path length
        const maxSteps = content.spread_path.length;
        
        // Update time slider
        const timeSlider = document.getElementById('timeSlider');
        timeSlider.min = 0;
        timeSlider.max = maxSteps - 1;
        timeSlider.value = 0;
        
        // Show timeline controls
        document.getElementById('timelineControls').style.display = 'block';
        document.getElementById('timeStep').textContent = 'Hop 0';
        
        // Show initial state (just the origin)
        updateTimelineStep(contentId, 0);
    }
    
    // Update visualization for a specific step in the timeline
    function updateTimelineStep(contentId, step) {
        // Find the selected content
        const content = window.contentFlowData.find(c => c.content_id === contentId);
        if (!content || !content.spread_path) return;
        
        // Clear existing visualization
        clearContentFlowVisualization();
        
        // Get node positions
        const nodePositions = {};
        networkData.nodes.forEach(node => {
            nodePositions[node.id] = { 
                x: node.x, 
                y: node.y
            };
        });
        
        // Determine color class
        let colorClass;
        if (content.accuracy >= 0.7) {
            colorClass = 'content-true';
        } else if (content.accuracy <= 0.3) {
            colorClass = 'content-false';
        } else {
            colorClass = 'content-fuzzy';
        }
        
        // Create SVG group
        const contentGroup = d3.select(".network-group")
            .selectAll(".content-paths-group")
            .data([1])
            .join("g")
            .attr("class", "content-paths-group");
        
        // Only include nodes up to the current step
        const visiblePath = content.spread_path.slice(0, step + 1);
        
        // Nothing to show for empty path
        if (visiblePath.length === 0) return;
        
        // Create path points
        const pathPoints = [];
        for (let i = 0; i < visiblePath.length; i++) {
            const nodeId = visiblePath[i];
            if (nodePositions[nodeId]) {
                pathPoints.push(nodePositions[nodeId]);
            }
        }
        
        // Draw path if we have multiple points
        if (pathPoints.length >= 2) {
            // Create a line generator
            const lineGenerator = d3.line()
                .x(d => d.x)
                .y(d => d.y)
                .curve(d3.curveCatmullRom.alpha(0.5));
                
            // Add path
            contentGroup.append("path")
                .attr("d", lineGenerator(pathPoints))
                .attr("class", `content-path ${colorClass}`)
                .style("stroke-width", 2.5)
                .style("opacity", 0.8);
        }
        
        // Add circles for each node in the visible path
        visiblePath.forEach((nodeId, i) => {
            if (!nodePositions[nodeId]) return;
            
            const pos = nodePositions[nodeId];
            const isOrigin = i === 0;
            const isLatestStep = i === step;
            
            // Larger circle for origin and current step
            const radius = isOrigin ? 8 : (isLatestStep ? 7 : 5);
            
            // Add node circle
            contentGroup.append("circle")
                .attr("cx", pos.x)
                .attr("cy", pos.y)
                .attr("r", radius)
                .attr("class", `content-node ${colorClass}`)
                .style("fill-opacity", isLatestStep ? 0.7 : 0.4)
                .style("stroke-width", isOrigin || isLatestStep ? 2 : 1);
                
            // Add step number
            contentGroup.append("text")
                .attr("x", pos.x)
                .attr("y", pos.y - radius - 2)
                .attr("text-anchor", "middle")
                .attr("font-size", "10px")
                .text(i + 1);
                
            // Add pulse effect for latest step
            if (isLatestStep) {
                contentGroup.append("circle")
                    .attr("cx", pos.x)
                    .attr("cy", pos.y)
                    .attr("r", radius)
                    .attr("class", `content-node ${colorClass} content-pulse`)
                    .style("fill", "none");
            }
        });
    }
    
    // Clear all content flow visualization elements
    function clearContentFlowVisualization() {
        d3.select(".content-paths-group").selectAll("*").remove();
    }
    
    // Chart Export Functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('.export-chart-btn')) {
            const button = e.target.closest('.export-chart-btn');
            const chartId = button.getAttribute('data-chart');
            const canvas = document.getElementById(chartId);
            
            if (canvas) {
                // Create a temporary link for download
                const link = document.createElement('a');
                link.download = `${chartId}_export.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    });
    
    // Network SVG Export Functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('#exportNetworkBtn')) {
            const svgEl = document.querySelector('#network-container svg');
            if (!svgEl) {
                alert('Network visualization not available for export');
                return;
            }
            
            // Get SVG source
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgEl);
            
            // Add namespaces if not already present
            if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            
            // Convert SVG source to a Blob
            const svgBlob = new Blob([source], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(svgBlob);
            
            // Create download link
            const link = document.createElement('a');
            link.download = 'network_visualization.svg';
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    });
    
    // JSON Export Functionality
    document.getElementById('exportJsonBtn')?.addEventListener('click', function() {
        if (!currentSimulationId) {
            alert('No simulation data to export');
            return;
        }
        
        // Trigger the download by navigating to the export endpoint
        window.location.href = `/api/export-simulation/${currentSimulationId}`;
    });
    
    // HTML Export Functionality
    document.getElementById('exportHtmlBtn')?.addEventListener('click', function() {
        if (!currentSimulationId) {
            alert('No simulation data to export');
            return;
        }
        
        // Trigger the download by navigating to the export endpoint
        window.location.href = `/api/export-html/${currentSimulationId}`;
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Truth & Credibility parameters
        updateRangeValue('truthSeekingMean');
        updateRangeValue('truthSeekingStd');
        updateRangeValue('initialTrustCorporate');
        updateRangeValue('initialTrustInfluencers');
        updateRangeValue('initialTrustGovernment');
        
        // Political Bias parameters
        updateRangeValue('corporateBiasMin');
        updateRangeValue('corporateBiasMax');
        updateRangeValue('influencerBiasMin');
        updateRangeValue('influencerBiasMax');
        updateRangeValue('governmentBias');
        
        // Trust Commitment parameters
        updateRangeValue('truthCommitmentCorporate');
        updateRangeValue('truthCommitmentInfluencer');
        updateRangeValue('truthCommitmentGovernment');
        
        // Publication Rate parameters
        updateRangeValue('corporatePublicationRate');
        updateRangeValue('influencerPublicationRate');
        updateRangeValue('governmentPublicationRate');
        
        // Influence Reach parameters
        updateRangeValue('corporateInfluenceReach');
        updateRangeValue('influencerInfluenceReach');
        updateRangeValue('governmentInfluenceReach');
        
        // Network parameters
        updateRangeValue('smallWorldP');
        updateRangeValue('randomP');
        
        // Cognitive parameters
        updateRangeValue('confirmationBiasMin');
        updateRangeValue('confirmationBiasMax');
        updateRangeValue('criticalThinkingMin');
        updateRangeValue('criticalThinkingMax');
        updateRangeValue('socialConformityMin');
        updateRangeValue('socialConformityMax');
        
        // Set up agent tracking elements
        document.getElementById('toggleAgentTracking').addEventListener('click', function() {
            const container = document.getElementById('agentTrackingContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                this.textContent = 'Hide';
            } else {
                container.style.display = 'none';
                this.textContent = 'Show/Hide';
            }
        });
        
        // Set up network visualization toggle
        document.getElementById('toggleNetworkViz').addEventListener('click', function() {
            const container = document.getElementById('networkVizContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                this.textContent = 'Hide';
            } else {
                container.style.display = 'none';
                this.textContent = 'Show/Hide';
            }
        });
        
        // Set up network visualization controls
        document.getElementById('resetZoom').addEventListener('click', resetNetworkZoom);
        document.getElementById('pauseSimulation').addEventListener('click', toggleNetworkSimulation);
        document.getElementById('refreshNetwork').addEventListener('click', refreshNetworkVisualization);
        document.getElementById('nodeColorSelect').addEventListener('change', updateNodeColors);
        document.getElementById('layoutSelect').addEventListener('change', changeNetworkLayout);
        document.getElementById('showLabels').addEventListener('change', toggleNodeLabels);
        
        // Set up content flow visualization controls
        initializeContentFlowControls();
        
        // Content type select event
        document.getElementById('contentTypeSelect').addEventListener('change', function() {
            const contentType = this.value;
            visualizeContentFlow(contentType);
        });
        
        // Set up agent selection change event
        document.getElementById('agentSelect').addEventListener('change', updateSelectedAgent);
        
        // Set up metric selection change event
        document.getElementById('agentMetricSelect').addEventListener('change', updateAgentChart);
        
        // Initialize the network visualization container
        initializeNetworkVisualization();
    });
    
    // Initialize the network visualization
    function initializeNetworkVisualization() {
        // Clear any existing SVG
        d3.select("#network-container svg").remove();
        
        // Get container dimensions
        const container = document.getElementById('network-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // Create SVG element
        networkSvg = d3.select("#network-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("class", "network-svg");
            
        // Add a group for zoom/pan behavior
        const g = networkSvg.append("g")
            .attr("class", "network-group");
            
        // Set up zoom behavior
        networkZoom = d3.zoom()
            .scaleExtent([0.1, 8])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });
            
        // Apply zoom behavior to SVG
        networkSvg.call(networkZoom);
        
        // Create link and node groups
        g.append("g").attr("class", "links");
        g.append("g").attr("class", "nodes");
        
        // Create tooltip
        d3.select("body").selectAll(".node-tooltip").remove();
        d3.select("body").append("div")
            .attr("class", "node-tooltip")
            .style("opacity", 0);
    }
    
    // Function to update the network visualization with new data
    function updateNetworkVisualization(data) {
        if (!data || !data.nodes || !data.links) {
            console.error("No valid network data provided");
            return;
        }
        
        // Store the network data globally
        networkData = data;
        
        // Get container dimensions
        const container = document.getElementById('network-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // Get the color attribute to use
        const colorAttribute = document.getElementById('nodeColorSelect').value;
        
        // Get the link and node groups
        const linkGroup = d3.select(".links");
        const nodeGroup = d3.select(".nodes");
        
        // Define color scales
        const truthColorScale = d3.scaleSequential()
            .domain([0, 1])
            .interpolator(d3.interpolateViridis);
            
        const trustColorScale = d3.scaleSequential()
            .domain([0, 10])
            .interpolator(d3.interpolateRdYlGn);
        
        // Determine which color scale to use
        const colorScale = colorAttribute === 'truth_assessment' ? truthColorScale : trustColorScale;
        
        // Create the force simulation with parameters optimized based on network type
        // Check if we're dealing with a small world network (which needs special handling)
        const isSmallWorld = data.nodes.length > 0 && data.links.length / data.nodes.length < 5;
        
        networkSimulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.links).id(d => d.id)
                .distance(isSmallWorld ? 30 : 60)) // Shorter distance for small world
            .force("charge", d3.forceManyBody()
                .strength(isSmallWorld ? -300 : -150)) // Stronger repulsion for small world
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("x", isSmallWorld ? d3.forceX(width / 2).strength(0.1) : null) // Add x-centering force for small world
            .force("y", isSmallWorld ? d3.forceY(height / 2).strength(0.1) : null) // Add y-centering force for small world
            .force("collision", d3.forceCollide().radius(isSmallWorld ? 15 : 20));
            
        // Create links
        networkLinks = linkGroup.selectAll(".link")
            .data(data.links)
            .join("line")
            .attr("class", "link")
            .attr("stroke-width", d => Math.sqrt(d.value));
            
        // Create nodes
        networkNodes = nodeGroup.selectAll(".node")
            .data(data.nodes)
            .join("circle")
            .attr("class", "node")
            .attr("r", d => d.size || 5)
            .attr("fill", d => {
                const value = d[colorAttribute] !== undefined ? d[colorAttribute] : 0;
                return colorScale(value);
            })
            .call(drag(networkSimulation))
            .on("mouseover", showNodeTooltip)
            .on("mouseout", hideNodeTooltip)
            .on("click", selectNode);
            
        // Add node labels if enabled
        updateNodeLabels();
        
        // Update the simulation on each tick
        networkSimulation.on("tick", () => {
            networkLinks
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
                
            networkNodes
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
                
            // Update labels position if they exist
            d3.selectAll(".node-label")
                .attr("x", d => d.x + 8)
                .attr("y", d => d.y);
        });
    }
    
    // Function to update node colors based on selected attribute
    function updateNodeColors() {
        if (!networkNodes || !networkData) return;
        
        const colorAttribute = document.getElementById('nodeColorSelect').value;
        
        // Define color scales
        const truthColorScale = d3.scaleSequential()
            .domain([0, 1])
            .interpolator(d3.interpolateViridis);
            
        const trustColorScale = d3.scaleSequential()
            .domain([0, 10])
            .interpolator(d3.interpolateRdYlGn);
        
        // Determine which color scale to use
        const colorScale = colorAttribute === 'truth_assessment' ? truthColorScale : trustColorScale;
        
        // Update node colors
        networkNodes.transition()
            .duration(750)
            .attr("fill", d => {
                const value = d[colorAttribute] !== undefined ? d[colorAttribute] : 0;
                return colorScale(value);
            });
    }
    
    // Function to toggle node labels
    function toggleNodeLabels() {
        updateNodeLabels();
    }
    
    // Function to update node labels
    function updateNodeLabels() {
        if (!networkData) return;
        
        const showLabels = document.getElementById('showLabels').checked;
        
        // Remove existing labels
        d3.selectAll(".node-label").remove();
        
        // Add labels if enabled
        if (showLabels) {
            d3.select(".nodes")
                .selectAll(".node-label")
                .data(networkData.nodes)
                .join("text")
                .attr("class", "node-label")
                .attr("x", d => d.x + 8)
                .attr("y", d => d.y)
                .attr("font-size", "8px")
                .text(d => `User ${d.agent_id}`);
        }
    }
    
    // Function to show node tooltip
    function showNodeTooltip(event, d) {
        const tooltip = d3.select(".node-tooltip");
        
        // Format tooltip content
        let content = `<strong>User ${d.agent_id}</strong><br>`;
        content += `Truth Assessment: ${d.truth_assessment.toFixed(3)}<br>`;
        
        if (d.trust_corporate !== undefined) {
            content += `Trust in Corporate: ${d.trust_corporate.toFixed(1)}<br>`;
        }
        
        if (d.trust_influencers !== undefined) {
            content += `Trust in Influencers: ${d.trust_influencers.toFixed(1)}<br>`;
        }
        
        if (d.trust_government !== undefined) {
            content += `Trust in Government: ${d.trust_government.toFixed(1)}`;
        }
        
        // Show tooltip
        tooltip.html(content)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px")
            .transition()
            .duration(200)
            .style("opacity", 0.9);
    }
    
    // Function to hide node tooltip
    function hideNodeTooltip() {
        d3.select(".node-tooltip")
            .transition()
            .duration(500)
            .style("opacity", 0);
    }
    
    // Function to select a node and update the agent tracking panel
    function selectNode(event, d) {
        // Find the agent in the dropdown and select it
        const agentSelect = document.getElementById('agentSelect');
        const agentId = d.agent_id;
        
        if (agentSelect.querySelector(`option[value="${agentId}"]`)) {
            agentSelect.value = agentId;
            // Trigger the change event
            agentSelect.dispatchEvent(new Event('change'));
            
            // Make sure the agent tracking panel is visible
            const container = document.getElementById('agentTrackingContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                document.getElementById('toggleAgentTracking').textContent = 'Hide';
            }
        }
    }
    
    // Drag function for nodes
    function drag(simulation) {
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }
        
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }
        
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
        
        return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
    }
    
    // Function to reset network zoom
    function resetNetworkZoom() {
        networkSvg.transition().duration(750).call(
            networkZoom.transform,
            d3.zoomIdentity,
            d3.zoomTransform(networkSvg.node()).invert([
                networkSvg.attr("width") / 2,
                networkSvg.attr("height") / 2
            ])
        );
    }
    
    // Function to toggle network simulation
    function toggleNetworkSimulation() {
        const button = document.getElementById('pauseSimulation');
        
        if (networkSimulation.alpha() > 0) {
            // Pause the simulation
            networkSimulation.stop();
            button.textContent = "Resume";
        } else {
            // Resume the simulation
            networkSimulation.alphaTarget(0.3).restart();
            setTimeout(() => networkSimulation.alphaTarget(0), 1000);
            button.textContent = "Pause";
        }
    }
    
    // Function to refresh the network visualization
    function refreshNetworkVisualization() {
        if (networkData) {
            initializeNetworkVisualization();
            updateNetworkVisualization(networkData);
        }
    }
    
    // Function to change the network layout
    function changeNetworkLayout() {
        if (!networkData || !networkSimulation) return;
        
        const layout = document.getElementById('layoutSelect').value;
        const width = document.getElementById('network-container').clientWidth;
        const height = document.getElementById('network-container').clientHeight;
        
        // Stop the current simulation
        networkSimulation.stop();
        
        // Apply the selected layout
        switch (layout) {
            case 'circular':
                applyCircularLayout(width, height);
                break;
            case 'grid':
                applyGridLayout(width, height);
                break;
            case 'radial':
                applyRadialLayout(width, height);
                break;
            case 'force':
            default:
                // Restart the force simulation
                networkSimulation.alpha(1).restart();
                break;
        }
        
        // Update the nodes and links positions
        updateVisualizationPositions();
    }
    
    // Function to apply a circular layout
    function applyCircularLayout(width, height) {
        const nodes = networkData.nodes;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.min(width, height) * 0.4;
        
        nodes.forEach((node, i) => {
            const angle = (i / nodes.length) * 2 * Math.PI;
            node.x = centerX + radius * Math.cos(angle);
            node.y = centerY + radius * Math.sin(angle);
            
            // Fix the node position
            node.fx = node.x;
            node.fy = node.y;
            
            // Schedule releasing the fixed position after a delay
            setTimeout(() => {
                node.fx = null;
                node.fy = null;
            }, 2000);
        });
    }
    
    // Function to apply a grid layout
    function applyGridLayout(width, height) {
        const nodes = networkData.nodes;
        const padding = 40;
        const availableWidth = width - 2 * padding;
        const availableHeight = height - 2 * padding;
        
        // Calculate grid dimensions based on number of nodes
        const cols = Math.ceil(Math.sqrt(nodes.length));
        const rows = Math.ceil(nodes.length / cols);
        
        // Calculate cell size
        const cellWidth = availableWidth / cols;
        const cellHeight = availableHeight / rows;
        
        nodes.forEach((node, i) => {
            const col = i % cols;
            const row = Math.floor(i / cols);
            
            node.x = padding + col * cellWidth + cellWidth / 2;
            node.y = padding + row * cellHeight + cellHeight / 2;
            
            // Fix the node position
            node.fx = node.x;
            node.fy = node.y;
            
            // Schedule releasing the fixed position after a delay
            setTimeout(() => {
                node.fx = null;
                node.fy = null;
            }, 2000);
        });
    }
    
    // Function to apply a radial tree layout
    function applyRadialLayout(width, height) {
        const nodes = networkData.nodes;
        const links = networkData.links;
        const centerX = width / 2;
        const centerY = height / 2;
        
        // Create a simple tree structure based on the first node as root
        if (nodes.length === 0) return;
        
        // Find the node with most connections as root
        const rootNodeIndex = findCentralNode(nodes, links);
        const rootNode = nodes[rootNodeIndex];
        
        // BFS to arrange nodes in levels
        const visited = new Set([rootNode.id]);
        const queue = [{ node: rootNode, level: 0, angle: 0 }];
        const levels = [[]];
        
        while (queue.length > 0) {
            const { node, level, angle } = queue.shift();
            
            // Add node to this level
            if (!levels[level]) levels[level] = [];
            levels[level].push({ node, angle });
            
            // Find connected nodes
            const connectedNodes = links
                .filter(link => link.source.id === node.id || link.target.id === node.id)
                .map(link => {
                    return link.source.id === node.id ? link.target : link.source;
                })
                .filter(n => !visited.has(n.id));
            
            // Mark connected nodes as visited and add to queue
            connectedNodes.forEach((n, i) => {
                visited.add(n.id);
                const newAngle = angle + (i / connectedNodes.length) * Math.PI / 2;
                queue.push({ node: n, level: level + 1, angle: newAngle });
            });
        }
        
        // Arrange nodes in radial layout
        const maxLevel = levels.length;
        
        levels.forEach((nodesInLevel, level) => {
            const radius = (level + 1) * (Math.min(width, height) * 0.3 / maxLevel);
            
            nodesInLevel.forEach((item, i) => {
                const angle = (i / nodesInLevel.length) * 2 * Math.PI;
                
                item.node.x = centerX + radius * Math.cos(angle + item.angle);
                item.node.y = centerY + radius * Math.sin(angle + item.angle);
                
                // Fix the node position
                item.node.fx = item.node.x;
                item.node.fy = item.node.y;
                
                // Schedule releasing the fixed position after a delay
                setTimeout(() => {
                    item.node.fx = null;
                    item.node.fy = null;
                }, 2000);
            });
        });
    }
    
    // Helper function to find the most central node in the network
    function findCentralNode(nodes, links) {
        // For simplicity, find the node with the most connections
        const connectionCounts = {};
        
        nodes.forEach(node => {
            connectionCounts[node.id] = 0;
        });
        
        links.forEach(link => {
            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;
            
            connectionCounts[sourceId] = (connectionCounts[sourceId] || 0) + 1;
            connectionCounts[targetId] = (connectionCounts[targetId] || 0) + 1;
        });
        
        // Find the node with highest connection count
        let maxConnections = 0;
        let mostConnectedNodeIndex = 0;
        
        nodes.forEach((node, index) => {
            if (connectionCounts[node.id] > maxConnections) {
                maxConnections = connectionCounts[node.id];
                mostConnectedNodeIndex = index;
            }
        });
        
        return mostConnectedNodeIndex;
    }
    
    // Function to update the visualization with current node positions
    function updateVisualizationPositions() {
        if (!networkNodes || !networkLinks) return;
        
        // Update nodes and links positions without animation
        networkNodes
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
            
        networkLinks
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
            
        // Update labels position if they exist
        d3.selectAll(".node-label")
            .attr("x", d => d.x + 8)
            .attr("y", d => d.y);
    }
    
    // Handle form submission
    document.getElementById('simulation-form').addEventListener('submit', function(e) {
        e.preventDefault();
        runSimulation();
    });
    
    function runSimulation() {
        // Show loading indicator
        document.getElementById('initial-message')?.classList.add('d-none');
        document.getElementById('results').classList.add('d-none');
        document.getElementById('loading').classList.remove('d-none');
        
        // Gather all form data
        const form = document.getElementById('simulation-form');
        const formData = {};
        
        // Use FormData to gather all inputs regardless of type
        new FormData(form).forEach((value, key) => {
            // Convert string number values to actual numbers
            if (!isNaN(value) && value !== "") {
                formData[key] = Number(value);
            } else {
                formData[key] = value;
            }
        });
        
        // Ensure formData uses the correct parameter names expected by the API
        const apiData = {
            // Basic parameters
            num_citizens: formData.numCitizens,
            num_corporate_media: formData.numCorporateMedia,
            num_influencers: formData.numInfluencers,
            num_government: formData.numGovernment,
            network_type: formData.networkType,
            steps: formData.steps,
            
            // Pass through all other parameters that already use snake_case
            ...Object.fromEntries(
                Object.entries(formData).filter(([key]) => key.includes('_'))
            )
        };
        
        // Make API request
        fetch('/api/run-simulation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(apiData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Get the run ID returned from the server
                const runId = data.run_id;
                
                // Use the database ID as the current simulation ID
                currentSimulationId = runId;
                
                console.log(`Simulation complete. Run ID: ${runId}`);
                
                // Display results
                displayResults(data.data, data.agent_data, data.network_data, data.content_flow_data);
            } else {
                alert('Error running simulation');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error running simulation: ' + error.message);
        })
        .finally(() => {
            // Hide loading indicator
            document.getElementById('loading').classList.add('d-none');
        });
    }
    
    // Agent selection and tracking functions
    function handleAgentData(agentData) {
        currentAgentData = agentData;
        
        // Get agent IDs from the first step
        const firstStep = Object.keys(agentData)[0];
        if (!firstStep) return;
        
        const agentIds = Object.keys(agentData[firstStep]);
        
        // Populate agent selection dropdown
        const agentSelect = document.getElementById('agentSelect');
        agentSelect.innerHTML = '<option value="">None Selected</option>';
        
        // Sort agent IDs numerically if possible
        agentIds.sort((a, b) => parseInt(a) - parseInt(b));
        
        agentIds.forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = `User ${id}`;
            agentSelect.appendChild(option);
        });
        
        // Select first agent by default
        if (agentIds.length > 0) {
            agentSelect.value = agentIds[0];
            selectedAgentId = agentIds[0];
            updateSelectedAgent();
        }
    }
    
    function updateSelectedAgent() {
        selectedAgentId = document.getElementById('agentSelect').value;
        
        if (!selectedAgentId || !currentAgentData) {
            clearAgentDisplay();
            return;
        }
        
        // Update agent properties table with the final step data
        const steps = Object.keys(currentAgentData).map(Number).sort((a, b) => a - b);
        const finalStep = steps[steps.length - 1].toString();
        
        if (currentAgentData[finalStep] && currentAgentData[finalStep][selectedAgentId]) {
            const agentData = currentAgentData[finalStep][selectedAgentId];
            
            // Update agent properties table
            document.getElementById('agentId').textContent = selectedAgentId;
            document.getElementById('agentTruthAssessment').textContent = 
                agentData.truth_assessment.toFixed(4);
            document.getElementById('agentConfirmationBias').textContent = 
                agentData.confirmation_bias.toFixed(2);
            document.getElementById('agentCriticalThinking').textContent = 
                agentData.critical_thinking.toFixed(2);
            
            // Update trust levels
            document.getElementById('agentTrustCorporate').textContent = 
                agentData.trust_levels.CorporateMediaAgent.toFixed(2);
            document.getElementById('agentTrustInfluencers').textContent = 
                agentData.trust_levels.InfluencerAgent.toFixed(2);
            document.getElementById('agentTrustGovernment').textContent = 
                agentData.trust_levels.GovernmentMediaAgent.toFixed(2);
        }
        
        // Update chart
        updateAgentChart();
    }
    
    function clearAgentDisplay() {
        document.getElementById('agentId').textContent = '-';
        document.getElementById('agentTruthAssessment').textContent = '-';
        document.getElementById('agentConfirmationBias').textContent = '-';
        document.getElementById('agentCriticalThinking').textContent = '-';
        document.getElementById('agentTrustCorporate').textContent = '-';
        document.getElementById('agentTrustInfluencers').textContent = '-';
        document.getElementById('agentTrustGovernment').textContent = '-';
        
        // Clear chart
        if (agentChart) {
            agentChart.destroy();
            agentChart = null;
        }
    }
    
    function updateAgentChart() {
        if (!selectedAgentId || !currentAgentData) return;
        
        const metricType = document.getElementById('agentMetricSelect').value;
        
        // Prepare data for chart
        const steps = Object.keys(currentAgentData).map(Number).sort((a, b) => a - b);
        const labels = steps;
        const agentValues = [];
        
        // Extract selected metric for each step
        steps.forEach(step => {
            const stepStr = step.toString();
            const stepData = currentAgentData[stepStr];
            
            if (stepData && stepData[selectedAgentId]) {
                const agent = stepData[selectedAgentId];
                
                // Get the appropriate metric value
                let value;
                switch(metricType) {
                    case 'truth_assessment':
                        value = agent.truth_assessment;
                        break;
                    case 'trust_corporate':
                        value = agent.trust_levels.CorporateMediaAgent;
                        break;
                    case 'trust_influencers':
                        value = agent.trust_levels.InfluencerAgent;
                        break;
                    case 'trust_government':
                        value = agent.trust_levels.GovernmentMediaAgent;
                        break;
                    default:
                        value = 0;
                }
                
                agentValues.push(value);
            }
        });
        
        // Get metric display name
        let metricName;
        switch(metricType) {
            case 'truth_assessment':
                metricName = 'Truth Assessment';
                break;
            case 'trust_corporate':
                metricName = 'Trust in Corporate Social Media Accounts';
                break;
            case 'trust_influencers':
                metricName = 'Trust in Social Media Influencers';
                break;
            case 'trust_government':
                metricName = 'Trust in Government Social Media Accounts';
                break;
            default:
                metricName = 'Value';
        }
        
        // Create chart data
        const chartData = {
            labels: labels,
            datasets: [
                {
                    label: `User ${selectedAgentId} - ${metricName}`,
                    data: agentValues,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }
            ]
        };
        
        // Create or update chart
        const ctx = document.getElementById('agentChart').getContext('2d');
        
        if (agentChart) {
            agentChart.destroy();
        }
        
        // Configure chart options
        const yMax = metricType === 'truth_assessment' ? 1 : 10;
        
        agentChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `${metricName} Over Time`,
                        font: { size: 16 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: yMax
                    }
                }
            }
        });
    }
    
    function displayResults(data, agentData, networkData, contentFlowData) {
        // Show results container
        document.getElementById('results').classList.remove('d-none');
        
        // Set initial state for network visualization container
        document.getElementById('networkVizContainer').style.display = 'block';
        document.getElementById('toggleNetworkViz').textContent = 'Hide';
        
        // Debug: log all received data
        console.log("Data received:", { 
            data: data, 
            agentData: agentData ? Object.keys(agentData).length : 0, 
            networkData: networkData ? `${networkData.nodes.length} nodes, ${networkData.links.length} links` : 'none',
            contentFlowData: contentFlowData ? contentFlowData.length : 'none'
        });
        
        // Prepare data for charts
        const steps = Array.from({length: data.length}, (_, i) => i);
        
        // Handle agent data if provided
        if (agentData) {
            handleAgentData(agentData);
        }
        
        // Initialize network visualization if data is provided
        if (networkData) {
            initializeNetworkVisualization();
            updateNetworkVisualization(networkData);
        }
        
        // Store content flow data if provided
        if (contentFlowData && contentFlowData.length > 0) {
            window.contentFlowData = contentFlowData;
            console.log(`Received ${contentFlowData.length} content flow items`);
            console.log("Sample content flow item:", contentFlowData[0]);
            
            // Enable content type selector
            document.getElementById('contentTypeSelect').disabled = false;
            
            // Calculate counts for each content type
            const trueCounts = contentFlowData.filter(c => c.accuracy >= 0.7).length;
            const falseCounts = contentFlowData.filter(c => c.accuracy <= 0.3).length;
            const fuzzyCounts = contentFlowData.filter(c => c.accuracy > 0.3 && c.accuracy < 0.7).length;
            
            // Update option text to show counts
            const select = document.getElementById('contentTypeSelect');
            
            // Update options text with counts
            Array.from(select.options).forEach(option => {
                if (option.value === 'true') {
                    option.text = `True Content (${trueCounts})`;
                } else if (option.value === 'false') {
                    option.text = `False Content (${falseCounts})`;
                } else if (option.value === 'fuzzy') {
                    option.text = `Fuzzy Content (${fuzzyCounts})`;
                } else if (option.value === 'all') {
                    option.text = `All Content Types (${contentFlowData.length})`;
                }
            });
            
            // Default to highlight mode to show all content reach
            select.value = 'all';
            visualizeContentFlow('all');
        } else {
            console.warn("No content flow data received from server");
            window.contentFlowData = [];
            
            // Disable content type selector if no data
            document.getElementById('contentTypeSelect').disabled = true;
        }
        
        // Truth assessment chart
        const truthAssessmentData = {
            labels: steps,
            datasets: [
                {
                    label: 'Average Truth Assessment',
                    data: data.map(d => d['Average Truth Assessment']),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                },
                {
                    label: 'Truth Assessment Variance',
                    data: data.map(d => d['Truth Assessment Variance']),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }
            ]
        };
        
        // Trust levels chart - updated with variance visualization
        const trustLevelsData = {
            labels: steps,
            datasets: [
                {
                    label: 'Trust in Corporate Social Media Accounts',
                    data: data.map(d => d['Trust in Corporate Media']),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1,
                    borderWidth: 3
                },
                {
                    label: 'Trust in Social Media Influencers',
                    data: data.map(d => d['Trust in Influencers']),
                    borderColor: 'rgb(255, 159, 64)', 
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    tension: 0.1,
                    borderWidth: 3
                },
                {
                    label: 'Trust in Government Social Media Accounts',
                    data: data.map(d => d['Trust in Government']),
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    tension: 0.1,
                    borderWidth: 3
                },
                // Add variance datasets for each media type
                {
                    label: 'Trust Variance - Corporate Accounts',
                    data: data.map(d => d['Trust Variance - Corporate'] ? Math.sqrt(d['Trust Variance - Corporate']) : 0),
                    borderColor: 'rgba(54, 162, 235, 0.5)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1,
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    yAxisID: 'y2'
                },
                {
                    label: 'Trust Variance - Social Media Influencers',
                    data: data.map(d => d['Trust Variance - Influencers'] ? Math.sqrt(d['Trust Variance - Influencers']) : 0),
                    borderColor: 'rgba(255, 159, 64, 0.5)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.1,
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    yAxisID: 'y2'
                },
                {
                    label: 'Trust Variance - Government Accounts',
                    data: data.map(d => d['Trust Variance - Government'] ? Math.sqrt(d['Trust Variance - Government']) : 0),
                    borderColor: 'rgba(153, 102, 255, 0.5)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    tension: 0.1,
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    yAxisID: 'y2'
                }
            ]
        };
        
        // Calculate trust changes (% change from initial value)
        const calculateChanges = (data, key) => {
            if (data.length < 2) return [0];
            
            const initial = data[0][key];
            return data.map(d => {
                // Calculate percent change from initial value
                const percentChange = initial !== 0 ? 
                    ((d[key] - initial) / initial) * 100 : 
                    0;
                return parseFloat(percentChange.toFixed(2));
            });
        };
        
        // Trust changes chart (shows % change from initial value)
        const trustChangesData = {
            labels: steps,
            datasets: [
                {
                    label: 'Corporate Social Media Trust Change (%)',
                    data: calculateChanges(data, 'Trust in Corporate Media'),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1
                },
                {
                    label: 'Social Media Influencers Trust Change (%)',
                    data: calculateChanges(data, 'Trust in Influencers'),
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    tension: 0.1
                },
                {
                    label: 'Government Social Media Trust Change (%)',
                    data: calculateChanges(data, 'Trust in Government'),
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    tension: 0.1
                }
            ]
        };
        
        // Create or update charts
        updateChart('truthAssessmentChart', truthAssessmentData, 'Truth Assessment Over Time', 'Steps', 'Value');
        updateChart('trustLevelsChart', trustLevelsData, 'Trust Levels Over Time', 'Steps', 'Trust Level (0-10)');
        updateChart('trustChangesChart', trustChangesData, 'Trust Level Changes', 'Steps', 'Percent Change (%)');
    }
    
    function updateChart(canvasId, data, title, xLabel, yLabel) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Destroy existing chart if it exists
        if (window[canvasId + 'Instance']) {
            window[canvasId + 'Instance'].destroy();
        }
        
        // Configure dual y-axis for trust charts
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: title,
                    font: {
                        size: 16
                    }
                },
                legend: {
                    position: 'top',
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: xLabel
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: yLabel
                    },
                    min: 0,
                    // Customize y-axis max value based on chart type
                    max: canvasId === 'truthAssessmentChart' ? 1 : 
                         canvasId === 'trustLevelsChart' ? 10 : undefined
                }
            }
        };
        
        // Add second y-axis for variance if this is the trust levels chart
        if (canvasId === 'trustLevelsChart') {
            chartOptions.scales.y2 = {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Trust Standard Deviation'
                },
                min: 0,
                max: 5,
                grid: {
                    drawOnChartArea: false
                }
            };
        }
        
        // Create new chart
        window[canvasId + 'Instance'] = new Chart(ctx, {
            type: 'line',
            data: data,
            options: chartOptions
        });
    }
</script>
{% endblock %}